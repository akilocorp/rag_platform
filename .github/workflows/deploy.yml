name: Deploy to EC2 (remote build)

on:
  push:
    branches: [ main, dev ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Upload repository to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ github.ref == 'refs/heads/dev' && 'ec2-18-224-2-163.us-east-2.compute.amazonaws.com' || secrets.EC2_HOST }}
        username: ${{ github.ref == 'refs/heads/dev' && secrets.DEV_EC2_USER || secrets.EC2_USER }}
        key: ${{ github.ref == 'refs/heads/dev' && secrets.DEV_EC2_SSH_KEY || secrets.EC2_SSH_KEY }}
        source: "."
        target: "~/rag_platform"
        overwrite: true

    - name: Deploy on EC2 (docker compose build & up)
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ github.ref == 'refs/heads/dev' && 'ec2-18-224-2-163.us-east-2.compute.amazonaws.com' || secrets.EC2_HOST }}
        username: ${{ github.ref == 'refs/heads/dev' && secrets.DEV_EC2_USER || secrets.EC2_USER }}
        key: ${{ github.ref == 'refs/heads/dev' && secrets.DEV_EC2_SSH_KEY || secrets.EC2_SSH_KEY }}
        script: |
          set -e

          # Install Docker and compose plugin if missing
          if ! command -v docker &> /dev/null; then
            sudo apt update
            sudo apt install -y docker.io docker-compose-plugin
            sudo usermod -aG docker $USER
          fi

          cd ~/rag_platform

          # Backend env file
          if [ ! -f ./backend/.env ]; then
            mkdir -p ./backend
            echo "MONGO_URI=${{ secrets.MONGO_URI }}" > ./backend/.env
            echo "MONGO_DB_NAME=${{ secrets.MONGO_DB_NAME }}" >> ./backend/.env
            echo "USER=${{ secrets.MONGO_USER_COLLECTION }}" >> ./backend/.env
            echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> ./backend/.env
            echo "JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}" >> ./backend/.env
            echo "SECRET_KEY=${{ secrets.FLASK_SECRET_KEY }}" >> ./backend/.env
          fi

          # Choose compose file and API URL per branch
          if [ "${GITHUB_REF}" = "refs/heads/dev" ]; then
            export FRONTEND_API_URL="http://ec2-18-224-2-163.us-east-2.compute.amazonaws.com:5000/api"
            COMPOSE_FILE="docker-compose.remote.dev.yml"
          else
            export FRONTEND_API_URL="${{ secrets.FRONTEND_API_URL }}"
            COMPOSE_FILE="docker-compose.remote.prod.yml"
          fi

          echo "Using compose file: $COMPOSE_FILE"
          echo "FRONTEND_API_URL=$FRONTEND_API_URL"

          # Bring up stack (build on server)
          sudo docker compose -f $COMPOSE_FILE down --remove-orphans || true
          sudo docker compose -f $COMPOSE_FILE build
          sudo docker compose -f $COMPOSE_FILE up -d

          # Show status
          sudo docker compose -f $COMPOSE_FILE ps
