name: Deploy to EC2

on:
  push:
    branches:
      - main
      - dev

jobs:
  dev-deploy:
    if: github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Print Dev environment info (safe)
        run: |
          echo "DEV_EC2_USER=${{ secrets.DEV_EC2_USER }}"
          echo "DEV_EC2_SSH_KEY length=${#DEV_EC2_SSH_KEY}"
          echo "MONGO_URI length=${#MONGO_URI}"
          echo "MONGO_DB_NAME=${{ secrets.MONGO_DB_NAME }}"
          echo "MONGO_USER_COLLECTION=${{ secrets.MONGO_USER_COLLECTION }}"
          echo "OPENAI_API_KEY length=${#OPENAI_API_KEY}"
          echo "JWT_SECRET_KEY length=${#JWT_SECRET_KEY}"
          echo "FLASK_SECRET_KEY length=${#FLASK_SECRET_KEY}"
        env:
          DEV_EC2_SSH_KEY: ${{ secrets.DEV_EC2_SSH_KEY }}
          MONGO_URI: ${{ secrets.MONGO_URI }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          FLASK_SECRET_KEY: ${{ secrets.FLASK_SECRET_KEY }}

      - name: Upload repository to Dev EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ec2-18-224-2-163.us-east-2.compute.amazonaws.com
          username: ${{ secrets.DEV_EC2_USER }}
          key: ${{ secrets.DEV_EC2_SSH_KEY }}
          source: "."
          target: "~/rag_platform"
          overwrite: true

      - name: Deploy on Dev EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ec2-18-224-2-163.us-east-2.compute.amazonaws.com
          username: ${{ secrets.DEV_EC2_USER }}
          key: ${{ secrets.DEV_EC2_SSH_KEY }}
          script: |
            set -e

            echo "Connected as $USER on EC2"

            # Install Docker and Compose if missing
            if ! command -v docker &> /dev/null; then
              sudo apt update || true
              sudo apt install -y docker.io docker-compose-plugin || true
              sudo usermod -aG docker $USER || true
            fi

            # Compose wrapper
            compose() {
              if docker compose version >/dev/null 2>&1; then
                sudo docker compose "$@"
              else
                sudo docker-compose "$@"
              fi
            }

            cd ~/rag_platform

            # Create backend .env
            mkdir -p ./backend
            cat > ./backend/.env <<EOF
            MONGO_URI=${MONGO_URI}
            MONGO_DB_NAME=${MONGO_DB_NAME}
            USER=${MONGO_USER_COLLECTION}
            OPENAI_API_KEY=${OPENAI_API_KEY}
            JWT_SECRET_KEY=${JWT_SECRET_KEY}
            SECRET_KEY=${FLASK_SECRET_KEY}
            EOF

                        export FRONTEND_API_URL="http://ec2-18-224-2-163.us-east-2.compute.amazonaws.com:5000/api"
                        COMPOSE_FILE="docker-compose.remote.dev.yml"

                        echo "Using compose file: $COMPOSE_FILE"
                        echo "FRONTEND_API_URL=$FRONTEND_API_URL"

                        compose -f $COMPOSE_FILE down --remove-orphans || true
                        compose -f $COMPOSE_FILE build
                        compose -f $COMPOSE_FILE up -d
                        compose -f $COMPOSE_FILE ps
        env:
          MONGO_URI: ${{ secrets.MONGO_URI }}
          MONGO_DB_NAME: ${{ secrets.MONGO_DB_NAME }}
          MONGO_USER_COLLECTION: ${{ secrets.MONGO_USER_COLLECTION }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          FLASK_SECRET_KEY: ${{ secrets.FLASK_SECRET_KEY }}
